<!-- The following code should appear at the beginning of the first appendix.
(if you have one)
After that, all subsequent sections will be turned into appendices. -->

`r if(knitr:::is_latex_output()) '% begin csasdown appendix'`
`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'`

\clearpage

# LIST OF SABLEFISH RESEARCH AND ASSESSMENT SURVEYS. {#app:first-appendix}

```{r appendixA, results="asis"}

   dtBW   <- paste('exec dbo.procRKnitr_SurveyTrips ', yr ,sep='')
   #trip   <- GetSQLData(dtBW,"Sablefish")
   #write.table(trip, file = paste(path,'appendixA.csv',sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")  
   trip   <-  read.csv(paste(path,'appendixA.csv',sep=''),header=T)
   
   colnames(trip) <- c("Year", "Dates",  "Vessel", "Captain", "Set Count", "GFBIO Id")
   kableExtra::kable(trip,
                     booktabs = TRUE, 
                     longtable = T,
                     linesep   = "",
                     format = "latex")  %>%
   kableExtra::kable_styling(font_size = 8) %>% 
                     row_spec(0, bold = T)

```

\clearpage

# DATA FORMS `r yr` SABLEFISH SURVEY. {#app:second-appendix}

```{r appendixB,out.width = "370px", out.height = "518px", fig.align="center"}

      if(knitr:::is_latex_output())
         # paper bridge log
         img <-  paste(basepath,'AppendixC1_BridgeLog.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure B.1. Example of a completed bridge log data form used during the `r yr` survey.  This form was completed from the bridge of the `r boat` for each set. 

\clearpage


```{r AppendixB2,out.width = "400px", out.height = "539px", fig.align="center"}

      if(knitr:::is_latex_output())
         # paper set log
         img <-  paste(basepath,'AppendixC2_SetLog.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure B.2.  Example of a completed set log data form used during the `r yr` survey.  This from was completed by science staff from the deck as the gear was set.

\clearpage

```{r AppendixB3,out.width = "370px", out.height = "599px", fig.align="center"}

      if(knitr:::is_latex_output())
         # paper catch log
         img <-  paste(basepath,'AppendixC3_CatchLog.png',sep='')
      knitr::include_graphics(img) 
      
```
Figure B.3.  Example of a completed catch log data form.
\clearpage

```{r AppendixB4,out.width = "370px", out.height = "600px", fig.align="center"}

      if(knitr:::is_latex_output())
         # paper tabular catch log
         img <-  paste(basepath,'AppendixC4_CatchLogTab.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure B.4.  Example of a tabular catch log data entry form transposed from the catch log in Figure C.3. 

\clearpage

```{r AppendixB5,out.width = "350px", out.height = "588px", fig.align="center"}

      if(knitr:::is_latex_output())
         # paper LSWMO log
         img <-  paste(basepath,'AppendixC5_LSWMO.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure B.5.  Example of a completed biological sampling form.

\clearpage  

```{r AppendixB6,out.width = "370px", out.height = "580px", fig.align="center"}

      if(knitr:::is_latex_output())
         # paper length sex species
         img <-  paste(basepath,'AppendixC6_LengthSexSpecies.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure B.6. Example of a completed LSS biological sampling form used during the `r yr` survey for samples of species other than sablefish or rougheye/blackspotted rockfish.

\clearpage 

```{r AppendixB7,out.width = "390px", out.height = "613px", fig.align="left"}

      if(knitr:::is_latex_output())
         # paper tagging sheet
         img <-  paste(basepath,'AppendixC7_TaggingSheet.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure B.7.  Example of a completed tagging form used during the `r yr` survey.

\clearpage

```{r AppendixB8,out.width = "370px", out.height = "600px", fig.align="left"}

      if(knitr:::is_latex_output())
         # paper tagging sheet
         img <-  paste(basepath,'AppendixC8_tagRecovery.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure B.8.  Example of a completed tag recovery form used during the `r yr` survey.  Image of recovered tag B9924900 (inset)

\clearpage

# SET DETAILS `r yr`. {#app:third-appendix}
Details of sets completed during the `r yr` survey program (F/V `r boat`).  Sets are listed by stratum/inlet name, set type, depth stratum, start date, end of gear deployment time and duration in minutes. The depth strata for type 3 tagging sets include RD~1~ (100-250 fathoms), RD~2~ (250-450 fathoms) and RD~3~ (450-750 fathoms). The position data includes the major area and start and end latitude and longitude in degrees decimal minutes. The bottom depths (in meters) of the fishing set are shown with the mean bottom depth calculated from recordings at one minute intervals between the start and end of the set. The number of traps fished for each set excludes open traps, while holed or fouled traps have been included.  Sets that successfully deployed a Seabird SBE temperature and pressure recorder or Hobo accelerometer or Nuytco autonomous camera system are indicated with an 'x'. 

```{r appendixC, results="asis"}
   library(kableExtra)

   options(knitr.kable.NA = '')  # get rid of NAs
   srvyset  <-  paste('dbo.procRReport_Survey_SetDetails ',yr,',1,',setcnt, sep='')
   #srvy.set   <-  GetSQLData(srvyset,"Sablefish")
   #write.table(srvy.set, file = paste(path,'appendixC.csv',sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")  
   srvy.set <-  read.csv(paste(path,'appendixC.csv',sep=''),header=T)
   #srvy.set <-  gsub("Use:","",srvy.set)
   
   latcnt  <-  length(srvy.set[,9])  # add degree symbol in lat and long values
               for (i in 1:latcnt)
                      { srvy.set[i,9]= paste(srvy.set[i,9],'째 ', srvy.set[i,10],"'N",sep="")  }
   latcnt  <-  length(srvy.set[,11])
               for (i in 1:latcnt)
                      { srvy.set[i,11]=paste(srvy.set[i,11],'째 ', srvy.set[i,12],"'W",sep="") }
   latcnt  <-  length(srvy.set[,13])
               for (i in 1:latcnt)
                      { srvy.set[i,13]=paste(srvy.set[i,13],'째 ', srvy.set[i,14],"'N",sep="") }
   latcnt<-length(srvy.set[,15])
               for (i in 1:latcnt)
                      { srvy.set[i,15]=paste(srvy.set[i,15],'째 ', srvy.set[i,16],"'W",sep="") }
   
   srvy.set  <-  srvy.set[,c(-23)] 
   srvy.set  <-  srvy.set[,c(-10,-12,-14,-16)]  
   srvy.set[,3] <- as.character(srvy.set[,3])

     j<-1
     for(j in explore.set) {
       srvy.set[j,3] <-  as.character('explore')
     }
     
     k<-1
       for( k in camera.set) {
       srvy.set[k,3] <- as.character('camera')
     }
     
     
     colnames(srvy.set) <- c("Spatial Stratum", "Set", "Type",      
                           "Depth Stratum",   "Date", "Time", 
                           "Duration (minutes)",  "Area", 
                           "Start Latitude",  "Start Longitude", 
                           "End Latitude",    "End Longitude", 
                           "Start Depth (m)", "End Depth (m)", "Mean Depth (m)", 
                           "Traps Fished",    "SBE 39", "Hobo", "Cam")
 
     kableExtra::kable(srvy.set,
                    booktabs  = TRUE, 
                    longtable = T,
                    linesep   = "",
                    escape = F,
                    align=c("c"),
                    format    = "latex") %>%
   kableExtra::kable_styling(font_size = 8, latex_options = "repeat_header",
               repeat_header_text = "continued.", 
               repeat_header_method = "replace") %>%
   kableExtra::landscape() %>%
    
   row_spec(0, bold = T)  %>%     
   column_spec(1,width    = "1.5cm") %>%  # stratum
   column_spec(2,width    = "0.7cm") %>%  # set
   column_spec(3,width    = "0.7cm") %>%  # type 
   column_spec(4,width    = "0.7cm") %>%  # depth stratum
   column_spec(5,width    = "0.9cm") %>%  # date
   column_spec(6,width    = "0.6cm") %>%  # time      
   column_spec(7,width    = "0.9cm") %>%  # dur
   column_spec(8,width    = "0.5cm") %>%  # area   
   column_spec(9,width    = "1.2cm") %>%  # start lat
   column_spec(10,width   = "1.7cm") %>%  # start long
   column_spec(11,width   = "1.2cm") %>%  # end lat
   column_spec(12,width   = "1.7cm") %>%  # end long
   column_spec(13,width   = "0.7cm") %>%  # start dep
   column_spec(14,width   = "0.7cm") %>%  # end dep    
   column_spec(15,width   = "0.5cm") %>%  # mean dep
   column_spec(16,width   = "0.6cm") %>%  # tf
   column_spec(17,width   = "0.4cm") %>%  # sbe
   column_spec(18,width   = "0.3cm") %>%  # hobo
   column_spec(19,width   = "0.3cm") %>%  # cam
   sub("\\caption\\[\\]\\{\\}", "\\caption*{}", .)
``` 

\clearpage

# SUMMARY OF BASKET USE BY TRAP `r yr`.{#app:fourth-appendix} 

Summary of the basket use by trap number for StRS sets during the `r yr` sablefish survey. The fate of the sablefish catch for each set and trap is indicated using the following abbreviations: D = Discarded after weighing (processed as commercial catch), A = Sampled for LSMWO, T = Tagged and released, F= Frames, NULL = No sablefish catch/trap missing. 

```{r appendixD, warning=FALSE, echo=FALSE, message=FALSE, error=FALSE}
   # Sablefish.dbo.procRReport_Survey_TrapUse procedure pulls 
   # data from table dbo.GFBIO_TRAPS_USE  
   # created by procedure Sablefish.dbo.Build_BIO_Sablefish_Tables
   options(knitr.kable.NA = '')
   trap       <- paste("dbo.procRReport_Survey_TrapUse ",yr,",1,",setcnt, sep="")
   #trapdat    <- GetSQLData(trap,"Sablefish")
   #write.table(trapdat, file = paste(path,'appendixD.csv',sep=''),row.names=FALSE,na="",col.names=TRUE,sep=",")    
   trapdat    <- read.csv(paste(path,'appendixD.csv',sep=''),header=T)
   trapuse2    <- trapdat[,c(-1, -28, -29)] 

   trapuse2$Trap.1     <- gsub('Use:', '', trapuse2$Trap.1) 
   trapuse2$Trap.11    <- gsub('Use:', '', trapuse2$Trap.11)
   trapuse2$Trap.12    <- gsub('Use:', '', trapuse2$Trap.12)   
   trapuse2$Trap.14    <- gsub('Use:', '', trapuse2$Trap.14)
   trapuse2$Trap.15    <- gsub('Use:', '', trapuse2$Trap.15)   
   trapuse2$Trap.18    <- gsub('Use:', '', trapuse2$Trap.18)
   trapuse2$Trap.20    <- gsub('Use:', '', trapuse2$Trap.20)
   
   i=0
   inlet.set   <- c(116:135)
   for (i in c(inlet.set)) {
      c    <- which(trapuse2$Set==i)  # identify inlet sets
      #trapuse2[c,1] <- paste("\\color{magenta}{", trapuse2$Set[c], "}") # r markdown magenta color in cell in third row 

   }
   
   kableExtra::kable(trapuse2,
                     booktabs = TRUE, 
                     longtable = T,
                     linesep   = "",
                     format = "latex")   %>%
      
   kableExtra::kable_styling(font_size = 6, 
                     latex_options = "repeat_header",
                     repeat_header_text = "continued.", 
                     repeat_header_method = "replace") %>%  
      
   kableExtra::landscape()  %>%
       #row_spec(114:133, color="magenta") %>%  
       row_spec(0, bold=T) %>%
       column_spec(1,width      = "0.3cm") %>%
       column_spec(2,width      = "0.3cm") %>%
       column_spec(3,width      = "0.3cm") %>%
       column_spec(4,width      = "0.3cm") %>%
       column_spec(5,width      = "0.3cm") %>%
       column_spec(6,width      = "0.3cm") %>%
       column_spec(7,width      = "0.3cm") %>%
       column_spec(8,width      = "0.3cm") %>%   
       column_spec(9,width      = "0.3cm") %>%   
       column_spec(10,width     = "0.3cm") %>%
       column_spec(11,width     = "0.4cm") %>%
       column_spec(12,width     = "0.4cm") %>%
       column_spec(13,width     = "0.4cm") %>%
       column_spec(14,width     = "0.4cm") %>%
       column_spec(15,width     = "0.4cm") %>%
       column_spec(16,width     = "0.4cm") %>%
       column_spec(17,width     = "0.4cm") %>%
       column_spec(18,width     = "0.4cm") %>%
       column_spec(19,width     = "0.4cm") %>%
       column_spec(20,width     = "0.4cm") %>%
       column_spec(21,width     = "0.4cm") %>%  
       column_spec(22,width     = "0.4cm") %>% 
       column_spec(23,width     = "0.4cm") %>%       
       column_spec(24,width     = "0.4cm") %>% 
       column_spec(25,width     = "0.4cm") %>%
       column_spec(26,width     = "0.4cm") %>%      
       column_spec(27,width     = "0.4cm") %>%  
       column_spec(28,width     = "0.4cm") 
```

\clearpage

```{r appendixESetUp, warning=FALSE, echo=FALSE, message=FALSE, error=FALSE}
library(knitr)
library(dplyr)
library(pander)
library(ggplot2)


    trap.count <-paste("select tp.YEAR, fe.TRIP_ID, fe.FE_MAJOR_LEVEL_ID AS SET_ID, fe.FE_SUB_LEVEL_ID AS BECKET, ", 
                      "fe.FE_MINOR_LEVEL_ID AS TRAP, SUM(c.CATCH_COUNT) AS total_count ",
                      "from dbo.GFBIO_TRAP_VW_VW AS fe INNER JOIN ",
                      "(select YEAR, TRIP_ID from dbo.SURVEY_trips_vw ",
                      " group by YEAR, TRIP_ID) AS tp ON fe.TRIP_ID = tp.TRIP_ID LEFT OUTER JOIN ",
                      " GFBioSQL.dbo.TRAP_SPECS AS ts ON fe.FISHING_EVENT_ID = ts.FISHING_EVENT_ID LEFT OUTER JOIN ",
                      " (select FISHING_EVENT_ID, SUM(CASE WHEN BAIT_LURE_CODE = 15 AND BAIT_METHOD_CODE = 4  ",
                      " then TRPBL_BAIT_AMOUNT ELSE NULL END) AS BAGGED_SQUID, SUM(CASE WHEN BAIT_LURE_CODE = 18 and  ", 
                      " BAIT_METHOD_CODE = 6 THEN TRPBL_BAIT_AMOUNT ELSE NULL END) AS LOOSE_HAKE,  ",
                      " SUM(CASE WHEN (BAIT_LURE_CODE <> 15 AND BAIT_METHOD_CODE <> 4) AND (BAIT_LURE_CODE <> 18 AND  ",
                      " BAIT_METHOD_CODE <> 6) THEN TRPBL_BAIT_AMOUNT ELSE NULL END) AS OTHER_BAIT ",
                      " from GFBioSQL.dbo.TRAP_BAIT_LURE ",
                      " group by FISHING_EVENT_ID) AS bait ON fe.FISHING_EVENT_ID = bait.FISHING_EVENT_ID  ",
                      " LEFT OUTER JOIN ",
                      " (select fec.FISHING_EVENT_ID, GFBioSQL.dbo.CATCH.SPECIES_CODE,  ",
                      " SUM(GFBioSQL.dbo.CATCH.CATCH_WEIGHT) AS CATCH_WEIGHT, SUM(GFBioSQL.dbo.CATCH.CATCH_COUNT) AS CATCH_COUNT,  ",
                      " AVG(ISNULL(GFBioSQL.dbo.CATCH.CATCH_VERIFICATION_CODE, 0)) AS VERIFICATION_METHOD ",
                      " from GFBioSQL.dbo.FISHING_EVENT_CATCH AS fec INNER JOIN ",
                      " GFBioSQL.dbo.CATCH ON fec.CATCH_ID = GFBioSQL.dbo.CATCH.CATCH_ID ",
                      " where (GFBioSQL.dbo.CATCH.SPECIES_CODE = '455') ",
                      " GROUP BY fec.FISHING_EVENT_ID, GFBioSQL.dbo.CATCH.SPECIES_CODE) AS c ON fe.FISHING_EVENT_ID = c.FISHING_EVENT_ID ",
                      " GROUP BY fe.FE_MAJOR_LEVEL_ID, fe.TRIP_ID, tp.YEAR, fe.FE_SUB_LEVEL_ID, fe.FE_MINOR_LEVEL_ID",
                      " having  (tp.YEAR IN ('",yr,"')) order by SET_ID, BECKET, TRAP",sep="")
    
   #trap.sable1   <- GetSQLData(trap.count,"Sablefish")
   #write.table(trap.sable1, file = paste(path,"appendixESetUp.csv",sep=''),row.names=FALSE, na="",col.names=TRUE, sep=",")
   trap.sable1  <-  read.csv(paste(path,'appendixESetUp.csv',sep=''), header=T)

   library(tidyverse)
   library(tidyr)
   library(scales)
   
   trap.sable <- trap.sable1[,c(-1,-2,-4)] 
   #trap.sable$SET_ID <- as.factor(trap.sable$SET_ID)
   names(trap.sable) <- c("SurveySet","Trap","Value")
   trap.sable[is.na(trap.sable)] <- 0

   #  trap.sableTest  <-  trap.sable[trap.sable$SurveySet == 40,] 
   big.value <- max(trap.sable$Value)

   w<-trap.sable %>%
     group_by(SurveySet) %>%
     do({
       p <- ggplot(., aes(x = Trap, y = Value)) + 
         geom_area( fill="#6495ED", alpha=0.4) +   #6495ED
         geom_line(size = 4, color = "blue") +      
         #geom_point(size=15, color="red") + 
         ylim(0, big.value) +
         xlim(0,25) +
         theme_void() 
         #stat_summary(fun.y = max, colour = "red", geom = "point", size = 5)
         #ggsave(p, filename = paste0("fig", unique(.$SurveySet), ".png"), width = 8, height = 2)  # save time comment out
       invisible(.) 
       
     })


```
# SUMMARY OF SABLEFISH BIOLOGICAL DATA `r yr`. {#app:fifth-appendix} 
Biological data collected for sablefish by set, catch weight in kilograms and numbers of fish.  Sablefish counts by trap are represented by sparklines. Details include a tally of specimens recovered, tagged and sampled.  Mean fork lengths for tagged sablefish and sampled male and female sablefish are listed.  


```{r appendixE, echo=FALSE}

   #  Sablefish.dbo.procReport_Survey_SampleDetails pulls data 
   #  from table GFBIO_RESEARCH_SAMPLE_DETAILS, built by     
   #  procedure Sablefish.dbo.Build_BIO_Sablefish_Tables 
   # \renewcommand{\arraystretch}{1} # use above r code to stretch table

   samples           <-  paste("dbo.procReport_Survey_SampleDetails ", yr ,",1,",setcnt, sep="")
   #surveyspec        <-  GetSQLData(samples,"Sablefish")
   #write.table(surveyspec, file = paste(path,'appendixE.csv',sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")  
   surveyspec        <-  read.csv(paste(path,'appendixE.csv',sep=''),header=T)
   count.row.total   <-  length(surveyspec$SET)
   count.row         <-  length(surveyspec$SET) - 1
   surveyspec$SET[count.row.total] <- "Total"

   surveyspec <-  surveyspec %>%
                  mutate(Sparkline = paste0("\\raisebox{.12\\height} {\\includegraphics[width=2cm]{fig",SET,".png}}") ) 
   
   i=0
   for (i in c(inlet.set)) {
      c    <- which(surveyspec$SET==i)  # identify inlet sets
      surveyspec[c,1] <- paste("\\color{green}{", surveyspec$SET[c], "}") # r markdown  color in cell 

   }
   j=0
   for (j in c(camera.set)) {
      c    <- which(surveyspec$SET==j)  # identify inlet sets
      surveyspec[c,1] <- paste("\\color{yellow}{", surveyspec$SET[c], "}") # r markdown  color in cell 

   }
   k=0
   for (k in c(explore.set)) {
      c    <- which(surveyspec$SET==k)  # identify inlet sets
      surveyspec[c,1] <- paste("\\color{magenta}{", surveyspec$SET[c], "}") # r markdown  color in cell 

   }
   
   
   
   colnames(surveyspec) <- c("", "kg","Count","Recover-Rerelease", "Deceased", "Released", 
                             "Count", "Mean", "Fork Length", "Sex","Maturity", "Otoliths",
                             "Weight","Count","Proportion Males", "Males", "Females", "Count by Trap")
   
   surveyspec <-  surveyspec[, c(1, 2, 3, 18, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17)]  #reorder table
   
   colnames(surveyspec) <- c("", "kg","Count","Count by Trap","Recover-Rerelease", "Deceased", "Released", 
                             "Count", "Mean", "Fork Length", "Sex","Maturity", "Otoliths",
                             "Weight","Count","Proportion Males", "Males", "Females" )

   kableExtra::kable(surveyspec,
                     booktabs = TRUE,     
                     longtable = T,
                     escape = F,        # lets the image show up 
                     linesep   = "",
                     align=rep('r', 18),
                     format = "latex") %>%
      
   add_header_above(c("Set"= 1,
                      "Total Catch" = 3, 
                      "Tagged Fish Counts" = 3,  
                      "Tagged Fork Lengths(mm)" = 2,
                      "Specimen Count"= 6, 
                      "Mean Fork Length(mm)" = 3), bold = TRUE) %>%
      
   kableExtra::kable_styling(font_size = 8, 
                     latex_options = "repeat_header",
                     repeat_header_text = "continued.", 
                     repeat_header_method = "replace") %>%     
   
   kableExtra::landscape()  %>%
   row_spec(0, bold = T)  %>%   
   column_spec(1,width    = "0.6cm") %>%  # set
   column_spec(2,width    = "0.6cm") %>%  # kg
   column_spec(3,width    = "0.7cm") %>%  # count
   column_spec(4,width    = "1.4cm") %>%  # sparkline      
   column_spec(5,width    = "0.9cm") %>%  # rr
   column_spec(6,width    = "1.0cm") %>%  # decease
   column_spec(7,width    = "0.9cm") %>%  # rel     
   column_spec(8,width    = "1.5cm") %>%  # count
   column_spec(9,width    = "0.9cm") %>%  # mean
   column_spec(10,width   = "0.5cm") %>%  # fl
   column_spec(11,width   = "0.5cm") %>%  # sex
   column_spec(12,width   = "0.7cm") %>%  # mat
   column_spec(13,width   = "0.7cm") %>%  # oto 
   column_spec(14,width   = "0.6cm") %>%  # wt
   column_spec(15,width   = "0.6cm") %>%  # cnt
   column_spec(16,width   = "1.1cm") %>%  # prop m
   column_spec(17,width   = "0.7cm") %>%  # male         
   column_spec(18,width   = "0.7cm") %>%  # fem
   row_spec(count.row.total, bold = T)  %>%    
   row_spec(count.row,  hline_after = T)

```
\clearpage



<!-- At the end of your appendices add: -->
`r if(knitr:::is_latex_output()) '% end csasdown appendix'`
